<!DOCTYPE html>
<html ng-app="resultPage">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="patternfly/css/patternfly.min.css">
</head>

<body onload="initData(0, 10)">

  <script src="js/jquery-1.11.1.min.js" language="javascript"></script>

  <table id="hostusb" class="datatable table table-striped table-bordered table-hover">
  </table>
  <ul class="pagination">
    <li>
      <a href="#" onclick="previousPage()">
        <span class="i fa fa-angle-left"></span>
      </a>
    </li>
    <li>
      <a href="#" id="pageInfo">1</a>
    </li>
    <li>
      <a href="#" onclick="nextPage()">
        <span class="i fa fa-angle-right"></span>
      </a>
    </li>
  </ul>
  <script>
    function getServerJson(url, cfunc, method, data) {
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                cfunc(JSON.parse(xmlhttp.responseText));
            }
        }
        xmlhttp.open(method, url, true);
        xmlhttp.setRequestHeader("Accept", "application/json");
        xmlhttp.setRequestHeader("Content-type", "application/json");
        xmlhttp.setRequestHeader("Prefer", "persistent-auth");
        xmlhttp.send(data);
    }

    function headerLine() {
        return toLine(
            ["虚拟机名称", "备份策略", "备份周期", "备份时间", "备份限制", "备份限制数"],
            true);
    }

    function toLine(arr, is_header) {
        var ret = "<tr>\n";
        var open = is_header?"<th>":"<td>";
        var close = is_header?"</th>":"</td>";
        for (var i = 0; i < arr.length; i++) {
            ret += open + arr[i] + close + "\n";
        }
        ret += "</tr>\n";
        return ret;
    }

    function addTableData(index, data) {
        if (data.length > index) {
            element = data[index];
            getServerJson("/ovirt-engine/api/vms/" + element.vmID, function(data1) {
                weekDaysEmpty = false;
                if (element.weekDays) {
                    weekDaysEmpty = true;
                }
                document.getElementById('hostusb').innerHTML += toLine(
                    [data1.name,
                    element.backupMethod==0 ? "增量备份（快照）" : "完全备份（导出）",
                    weekDaysEmpty ? "按天" : "按星期",
                    element.timeOfDay,
                    element.autoDeleteReservePolicy==0 ? "按备份数量" : "按备份时间（天）",
                    element.autoDeleteReserveAmount],
                    false);
                addTableData(index+1, data);
            }, "GET");
        }
    }

    function initData(begin, length) {
        getServerJson("/vmBackupScheduler/vmPolicies?page=" + begin + "-" + length, function(data) {
            content = headerLine();
            document.getElementById('hostusb').innerHTML = content;
            addTableData(0, data);
        },
        "GET"
        );
    }

    function previousPage() {
        i = parseInt(document.getElementById('pageInfo').innerHTML);
        if (i == 1) {
            return;
        }
        document.getElementById('pageInfo').innerHTML = i - 1;
        initData((i - 2)*10, 10);
    }

    function nextPage() {
        i = parseInt(document.getElementById('pageInfo').innerHTML);
        document.getElementById('pageInfo').innerHTML = i + 1;
        initData(i*10, 10);
    }
  </script>
</body>
</html>
