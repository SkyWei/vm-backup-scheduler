<!DOCTYPE html>
<html ng-app="resultPage">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="dist/css/patternfly.min.css">
  <link rel="stylesheet" href="patternfly/css/patternfly.min.css">
</head>

<body onload="initData(0, 10)">

  <script src="js/jquery-1.11.1.min.js" language="javascript"></script>
  <script src="js/jquery.localize.min.js" language="javascript"></script>

  <h3 data-localize="table-title">List of all the Enabled Backup Plan: </h3>
  <table class="table table-striped table-bordered table-hover">
    <thead id="tableHead">
      <tr>
        <th data-localize="thead-vm">VM</th>
        <th data-localize="thead-type">Type</th>
        <th data-localize="thead-schedule">Schedule</th>
        <th data-localize="thead-time">Time</th>
        <th data-localize="thead-restriction">Restriction</th>
        <th data-localize="thead-limit">Limit of the Restriction</th>
      </tr>
    </thead>
    <tbody id="tableBody">

    </tbody>
  </table>
  <ul class="pagination">
    <li>
      <a href="#" onclick="previousPage()">
        <span class="i fa fa-angle-left"></span>
      </a>
    </li>
    <li>
      <a href="#" id="pageInfo">1</a>
    </li>
    <li>
      <a href="#" onclick="nextPage()">
        <span class="i fa fa-angle-right"></span>
      </a>
    </li>
  </ul>
  <script>
    function getServerJson(url, cfunc, method, data) {
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                cfunc(JSON.parse(xmlhttp.responseText));
            }
        }
        xmlhttp.open(method, url, true);
        xmlhttp.setRequestHeader("Accept", "application/json");
        xmlhttp.setRequestHeader("Content-type", "application/json");
        xmlhttp.setRequestHeader("Prefer", "persistent-auth");
        xmlhttp.send(data);
    }

    function addTableData(index, data) {
        if (data.length > index) {
            element = data[index];

            getServerJson("/ovirt-engine/api/vms/" + element.vmID, function(data1) {

                weekDaysEmpty = true;
                if (element.weekDays) {
                    weekDaysEmpty = false;
                }

                var backupTypeLocalize = "tbody-full";
                var backupType = "Full (Export)";
                if (element.backupMethod==0){
                  backupTypeLocalize = "tbody-incremental";
                  backupType = "Incremental (Snapshots)";
                }

                var weekDays = '<span class="label label-success" data-localize="tbody-everyday">Everyday</span>';
                if (!weekDaysEmpty) {
                  weekDays = getWeekDays(element.weekDays);
                }


                var backupPolicyLocalize = 'tbody-old';
                var backupPolicy = 'Delete backups older than (days)';
                if(element.autoDeleteReservePolicy==0){
                  backupPolicyLocalize = 'tbody-number';
                  backupPolicy = 'Number of backups to keep';
                }

                var newVMLine = '<tr><td>' + data1.name + '</td>'
                            + '<td data-localize="' + backupTypeLocalize + '">' + backupType + '</td>'
                            + '<td>' + weekDays + '</td>'
                            + '<td>' + element.timeOfDay + '</td>'
                            + '<td data-localize="' + backupPolicyLocalize + '">' + backupPolicy + '</td>'
                            + '<td>' + element.autoDeleteReserveAmount + '</td></tr>' ;


                document.getElementById('tableBody').innerHTML += newVMLine;
                addTableData(index+1, data);
            }, "GET");
        }
    }

    function getWeekDays(weekDays) {
        var value = "";
        var weekString = ['<span class="label label-info" data-localize="tbody-sunday">Sunday</span>',
                          '<span class="label label-info" data-localize="tbody-monday">Monday</span>',
                          '<span class="label label-info" data-localize="tbody-tuesday">Tuesday</span>',
                          '<span class="label label-info" data-localize="tbody-wednesday">Wednesday</span>',
                          '<span class="label label-info" data-localize="tbody-thursday">Thursday</span>',
                          '<span class="label label-info" data-localize="tbody-friday">Friday</span>',
                          '<span class="label label-info" data-localize="tbody-saturday">Saturday</span>'];
        for (var i=0; i<7; i++) {
            if (weekDays[i] == "1") {
                value += weekString[i];
            }
        }
        return value ? value : '<span class="label label-warning" data-localize="tbody-weeklynoday">Weekly (no day specified)</span>';
    }

    function initData(begin, length) {
        getServerJson("/vmBackupScheduler/vmPolicies?page=" + begin + "-" + length, function(data) {
            document.getElementById('tableBody').innerHTML = "";
            addTableData(0, data);
        },
        "GET"
        );
    }

    function previousPage() {
        i = parseInt(document.getElementById('pageInfo').innerHTML);
        if (i == 1) {
            return;
        }
        document.getElementById('pageInfo').innerHTML = i - 1;
        initData((i - 2)*10, 10);
    }

    function nextPage() {
        i = parseInt(document.getElementById('pageInfo').innerHTML);
        document.getElementById('pageInfo').innerHTML = i + 1;
        initData(i*10, 10);
    }
  </script>

  <script>
    $(document).ready(setTimeout($("[data-localize]").localize("mainTabResult", { skipLanguage: /^en/ }),20000));

  </script>

</body>
</html>
