#!/bin/bash

usage() {
    cat << __EOF__
Usage: $0 [--password=PASSWORD]
    --password=PASSWORD
        The admin@internal's password.
    -h, --help
    Show this help message.

__EOF__
    exit 1
}

function isInstalled {
  if yum list installed "$@" >/dev/null 2>&1; then
    return 1
  else
    return 0
  fi
}

x="$1"
v="${x#*=}"
shift
case "${x}" in
    --password=*)
        PASSWORD="${v}"
    ;;
    --help)
        usage
    ;;
    -h)
        usage
    ;;
    *)
        usage
    ;;
esac

setup() {
    echo "Creating database..."
    sudo -su postgres createdb -O engine ovirtbackup

    echo "Creating tables..."
    if id -u 'engine' >/dev/null 2>&1; then
        echo "user 'engine' exists"
    else
        echo "user 'engine' does not exist, creating..."
        useradd engine
    fi
    sudo -su engine psql -d ovirtbackup -a -f /usr/share/engine-vm-backup/createdb.sql

    echo "Updating db password to vm-backup.xml..."
    . /etc/ovirt-engine/engine.conf.d/10-setup-database.conf
    sed -i "s/<password>.*<\/password>/<password>$ENGINE_DB_PASSWORD<\/password>/"\
     /etc/engine-vm-backup/engine-vm-backup.xml

    if ! grep -q ovirtbackup /var/lib/pgsql/data/pg_hba.conf; then
        echo "updating pg_hba.conf..."
        LINENUM=$(grep -n '^local' /var/lib/pgsql/data/pg_hba.conf |cut -f1 -d:)
        sed -i "$((LINENUM+2))ihost    ovirtbackup    engine    0.0.0.0/0    md5" /var/lib/pgsql/data/pg_hba.conf
    fi

    sed -i "s/secrete/$PASSWORD/"\
     /etc/engine-vm-backup/engine-vm-backup.properties

    echo ""
    echo "Adding service to auto start"
	if [[ ! -z $(pidof systemd) ]]; then
		systemctl enable engine-vm-backup.service
	else
		chkconfig --add engine-vm-backup
    	chkconfig engine-vm-backup on
	fi
    echo "stopping engine"
	if [[ ! -z $(pidof systemd) ]]; then
		systemctl stop ovirt-engine.service
	else
		/etc/init.d/ovirt-engine stop
	fi
    echo "stopping dwh&reports"
	if [[ (! -z $(pidof systemd)) && (isInstalled ovirt-engine-reports) ]]; then
		systemctl stop ovirt-engine-reportsd.service
		systemctl stop ovirt-engine-dwhd.service
	else
    	/etc/init.d/ovirt-engine-reportsd stop
    	/etc/init.d/ovirt-engine-dwhd stop
	fi
    echo "restarting postgresql"
	if [[ ! -z $(pidof systemd) ]]; then
		systemctl restart postgresql.service
	else
    	/etc/init.d/postgresql restart
	fi
    echo "starting engine"
	if [[ ! -z $(pidof systemd) ]]; then
		systemctl start ovirt-engine.service
	else
    	/etc/init.d/ovirt-engine start
	fi
    echo "starting dwh&reports"
    if [[ (! -z $(pidof systemd)) && (isInstalled ovirt-engine-reports) ]]; then
        systemctl start ovirt-engine-reportsd.service
        systemctl start ovirt-engine-dwhd.service
    else
        /etc/init.d/ovirt-engine-reportsd start
        /etc/init.d/ovirt-engine-dwhd start
    fi
    echo "Restarting httpd"
	if [[ ! -z $(pidof systemd) ]]; then
		systemctl restart httpd.service
	else
    	/etc/init.d/httpd restart
	fi
    echo "Staring engine-vm-backup service..."
	if [[ ! -z $(pidof systemd) ]]; then
		systemctl start engine-vm-backup.service
	else
    	/etc/rc.d/init.d/engine-vm-backup start
	fi
    echo "Setup proccess completed."
}

if [ ! -z $PASSWORD ]; then
    setup
fi